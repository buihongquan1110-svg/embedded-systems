#include "stm32f10x.h"
#include <stdio.h>


const uint8_t Font6x8[][6] = {
{0x00,0x00,0x00,0x00,0x00,0x00}, // 32 (space)
{0x00,0x00,0x5F,0x00,0x00,0x00}, // 33 !
{0x00,0x07,0x00,0x07,0x00,0x00}, // 34 "
{0x14,0x7F,0x14,0x7F,0x14,0x00}, // 35 #
{0x24,0x2A,0x7F,0x2A,0x12,0x00}, // 36 $
{0x23,0x13,0x08,0x64,0x62,0x00}, // 37 %
{0x36,0x49,0x55,0x22,0x50,0x00}, // 38 &
{0x00,0x05,0x03,0x00,0x00,0x00}, // 39 '
{0x00,0x1C,0x22,0x41,0x00,0x00}, // 40 (
{0x00,0x41,0x22,0x1C,0x00,0x00}, // 41 )
{0x14,0x08,0x3E,0x08,0x14,0x00}, // 42 *
{0x08,0x08,0x3E,0x08,0x08,0x00}, // 43 +
{0x00,0x50,0x30,0x00,0x00,0x00}, // 44 ,
{0x08,0x08,0x08,0x08,0x08,0x00}, // 45 -
{0x00,0x60,0x60,0x00,0x00,0x00}, // 46 .
{0x20,0x10,0x08,0x04,0x02,0x00}, // 47 /
{0x3E,0x51,0x49,0x45,0x3E,0x00}, // 48 0
{0x00,0x42,0x7F,0x40,0x00,0x00}, // 49 1
{0x42,0x61,0x51,0x49,0x46,0x00}, // 50 2
{0x21,0x41,0x45,0x4B,0x31,0x00}, // 51 3
{0x18,0x14,0x12,0x7F,0x10,0x00}, // 52 4
{0x27,0x45,0x45,0x45,0x39,0x00}, // 53 5
{0x3C,0x4A,0x49,0x49,0x30,0x00}, // 54 6
{0x01,0x71,0x09,0x05,0x03,0x00}, // 55 7
{0x36,0x49,0x49,0x49,0x36,0x00}, // 56 8
{0x06,0x49,0x49,0x29,0x1E,0x00}, // 57 9
{0x00,0x36,0x36,0x00,0x00,0x00}, // 58 :
{0x00,0x56,0x36,0x00,0x00,0x00}, // 59 ;
{0x08,0x14,0x22,0x41,0x00,0x00}, // 60 <
{0x14,0x14,0x14,0x14,0x14,0x00}, // 61 =
{0x00,0x41,0x22,0x14,0x08,0x00}, // 62 >
{0x02,0x01,0x51,0x09,0x06,0x00}, // 63 ?
{0x32,0x49,0x79,0x41,0x3E,0x00}, // 64 @
{0x7E,0x11,0x11,0x11,0x7E,0x00}, // 65 A
{0x7F,0x49,0x49,0x49,0x36,0x00}, // 66 B
{0x3E,0x41,0x41,0x41,0x22,0x00}, // 67 C
{0x7F,0x41,0x41,0x22,0x1C,0x00}, // 68 D
{0x7F,0x49,0x49,0x49,0x41,0x00}, // 69 E
{0x7F,0x09,0x09,0x09,0x01,0x00}, // 70 F
{0x3E,0x41,0x49,0x49,0x7A,0x00}, // 71 G
{0x7F,0x08,0x08,0x08,0x7F,0x00}, // 72 H
{0x00,0x41,0x7F,0x41,0x00,0x00}, // 73 I
{0x20,0x40,0x41,0x3F,0x01,0x00}, // 74 J
{0x7F,0x08,0x14,0x22,0x41,0x00}, // 75 K
{0x7F,0x40,0x40,0x40,0x40,0x00}, // 76 L
{0x7F,0x02,0x0C,0x02,0x7F,0x00}, // 77 M
{0x7F,0x04,0x08,0x10,0x7F,0x00}, // 78 N
{0x3E,0x41,0x41,0x41,0x3E,0x00}, // 79 O
{0x7F,0x09,0x09,0x09,0x06,0x00}, // 80 P
{0x3E,0x41,0x51,0x21,0x5E,0x00}, // 81 Q
{0x7F,0x09,0x19,0x29,0x46,0x00}, // 82 R
{0x46,0x49,0x49,0x49,0x31,0x00}, // 83 S
{0x01,0x01,0x7F,0x01,0x01,0x00}, // 84 T
{0x3F,0x40,0x40,0x40,0x3F,0x00}, // 85 U
{0x1F,0x20,0x40,0x20,0x1F,0x00}, // 86 V
{0x7F,0x20,0x18,0x20,0x7F,0x00}, // 87 W
{0x63,0x14,0x08,0x14,0x63,0x00}, // 88 X
{0x07,0x08,0x70,0x08,0x07,0x00}, // 89 Y
{0x61,0x51,0x49,0x45,0x43,0x00}, // 90 Z
{0x00,0x7F,0x41,0x41,0x00,0x00}, // 91 [
{0x02,0x04,0x08,0x10,0x20,0x00}, // 92 backslash
{0x00,0x41,0x41,0x7F,0x00,0x00}, // 93 ]
{0x04,0x02,0x01,0x02,0x04,0x00}, // 94 ^
{0x40,0x40,0x40,0x40,0x40,0x00}, // 95 _
{0x00,0x01,0x02,0x04,0x00,0x00}, // 96 `
{0x20,0x54,0x54,0x54,0x78,0x00}, // 97 a
{0x7F,0x48,0x44,0x44,0x38,0x00}, // 98 b
{0x38,0x44,0x44,0x44,0x20,0x00}, // 99 c
{0x38,0x44,0x44,0x48,0x7F,0x00}, // 100 d
{0x38,0x54,0x54,0x54,0x18,0x00}, // 101 e
{0x08,0x7E,0x09,0x01,0x02,0x00}, // 102 f
{0x0C,0x52,0x52,0x52,0x3E,0x00}, // 103 g
{0x7F,0x08,0x04,0x04,0x78,0x00}, // 104 h
{0x00,0x44,0x7D,0x40,0x00,0x00}, // 105 i
{0x20,0x40,0x44,0x3D,0x00,0x00}, // 106 j
{0x7F,0x10,0x28,0x44,0x00,0x00}, // 107 k
{0x00,0x41,0x7F,0x40,0x00,0x00}, // 108 l
{0x7C,0x04,0x18,0x04,0x78,0x00}, // 109 m
{0x7C,0x08,0x04,0x04,0x78,0x00}, // 110 n
{0x38,0x44,0x44,0x44,0x38,0x00}, // 111 o
{0x7C,0x14,0x14,0x14,0x08,0x00}, // 112 p
{0x08,0x14,0x14,0x18,0x7C,0x00}, // 113 q
{0x7C,0x08,0x04,0x04,0x08,0x00}, // 114 r
{0x48,0x54,0x54,0x54,0x20,0x00}, // 115 s
{0x04,0x3F,0x44,0x40,0x20,0x00}, // 116 t
{0x3C,0x40,0x40,0x20,0x7C,0x00}, // 117 u
{0x1C,0x20,0x40,0x20,0x1C,0x00}, // 118 v
{0x3C,0x40,0x30,0x40,0x3C,0x00}, // 119 w
{0x44,0x28,0x10,0x28,0x44,0x00}, // 120 x
{0x0C,0x50,0x50,0x50,0x3C,0x00}, // 121 y
{0x44,0x64,0x54,0x4C,0x44,0x00}, // 122 z
{0x00,0x08,0x36,0x41,0x00,0x00}, // 123 {
{0x00,0x00,0x7F,0x00,0x00,0x00}, // 124 |
{0x00,0x41,0x36,0x08,0x00,0x00}, // 125 }
{0x08,0x04,0x08,0x10,0x08,0x00}, // 126 ~
};



void UART1_Init(void) {
    GPIO_InitTypeDef gpio;
    USART_InitTypeDef usart;

    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_USART1, ENABLE);

    // PA9 = TX
    gpio.GPIO_Pin = GPIO_Pin_9;
    gpio.GPIO_Mode = GPIO_Mode_AF_PP;
    gpio.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOA, &gpio);

    // PA10 = RX
    gpio.GPIO_Pin = GPIO_Pin_10;
    gpio.GPIO_Mode = GPIO_Mode_IN_FLOATING;
    GPIO_Init(GPIOA, &gpio);

    usart.USART_BaudRate = 115200;
    usart.USART_WordLength = USART_WordLength_8b;
    usart.USART_StopBits = USART_StopBits_1;
    usart.USART_Parity = USART_Parity_No;
    usart.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
    usart.USART_Mode = USART_Mode_Tx | USART_Mode_Rx;
    USART_Init(USART1, &usart);
    USART_Cmd(USART1, ENABLE);
}

void UART1_SendChar(char c) {
    while (!(USART1->SR & USART_SR_TXE));
    USART1->DR = c;
}

void UART1_SendString(char *s) {
    while (*s) UART1_SendChar(*s++);
}


void SPI1_Init(void) {
    GPIO_InitTypeDef gpio;
    SPI_InitTypeDef spi;

    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_SPI1, ENABLE);

    // PA5 = SCK, PA7 = MOSI
    gpio.GPIO_Pin = GPIO_Pin_5 | GPIO_Pin_7;
    gpio.GPIO_Mode = GPIO_Mode_AF_PP;
    gpio.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOA, &gpio);

    // PA6 = MISO
    gpio.GPIO_Pin = GPIO_Pin_6;
    gpio.GPIO_Mode = GPIO_Mode_IN_FLOATING;
    GPIO_Init(GPIOA, &gpio);

    // PA4 = CS
    gpio.GPIO_Pin = GPIO_Pin_4;
    gpio.GPIO_Mode = GPIO_Mode_Out_PP;
    gpio.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOA, &gpio);
    GPIO_SetBits(GPIOA, GPIO_Pin_4);

    spi.SPI_Direction = SPI_Direction_2Lines_FullDuplex;
    spi.SPI_Mode = SPI_Mode_Master;
    spi.SPI_DataSize = SPI_DataSize_8b;
    spi.SPI_CPOL = SPI_CPOL_Low;
    spi.SPI_CPHA = SPI_CPHA_1Edge;
    spi.SPI_NSS = SPI_NSS_Soft;
    spi.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_16;
    spi.SPI_FirstBit = SPI_FirstBit_MSB;
    spi.SPI_CRCPolynomial = 7;
    SPI_Init(SPI1, &spi);
    SPI_Cmd(SPI1, ENABLE);
}

uint8_t SPI1_Transfer(uint8_t data) {
    while (!(SPI1->SR & SPI_SR_TXE));
    SPI1->DR = data;
    while (!(SPI1->SR & SPI_SR_RXNE));
    return SPI1->DR;
}

// ================= OLED SSD1306 =================
#define OLED_CS_LOW()   GPIO_ResetBits(GPIOA, GPIO_Pin_4)
#define OLED_CS_HIGH()  GPIO_SetBits(GPIOA, GPIO_Pin_4)
#define OLED_DC_LOW()   GPIO_ResetBits(GPIOB, GPIO_Pin_0)  // DC
#define OLED_DC_HIGH()  GPIO_SetBits(GPIOB, GPIO_Pin_0)
#define OLED_RES_LOW()  GPIO_ResetBits(GPIOB, GPIO_Pin_1)  // RST
#define OLED_RES_HIGH() GPIO_SetBits(GPIOB, GPIO_Pin_1)

void OLED_WriteCmd(uint8_t cmd) {
    OLED_DC_LOW();
    OLED_CS_LOW();
    SPI1_Transfer(cmd);
    OLED_CS_HIGH();
}

void OLED_WriteData(uint8_t data) {
    OLED_DC_HIGH();
    OLED_CS_LOW();
    SPI1_Transfer(data);
    OLED_CS_HIGH();
}

void OLED_Init(void) {
    GPIO_InitTypeDef gpio;
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);

    gpio.GPIO_Pin = GPIO_Pin_0 | GPIO_Pin_1; // DC, RST
    gpio.GPIO_Mode = GPIO_Mode_Out_PP;
    gpio.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOB, &gpio);

    // reset
    OLED_RES_LOW(); for (volatile int i = 0; i < 10000; i++);
    OLED_RES_HIGH();

    // init sequence
    OLED_WriteCmd(0xAE);
    OLED_WriteCmd(0xD5); OLED_WriteCmd(0x80);
    OLED_WriteCmd(0xA8); OLED_WriteCmd(0x3F);
    OLED_WriteCmd(0xD3); OLED_WriteCmd(0x00);
    OLED_WriteCmd(0x40);
    OLED_WriteCmd(0x8D); OLED_WriteCmd(0x14);
    OLED_WriteCmd(0x20); OLED_WriteCmd(0x00);
    OLED_WriteCmd(0xA1);
    OLED_WriteCmd(0xC8);
    OLED_WriteCmd(0xDA); OLED_WriteCmd(0x12);
    OLED_WriteCmd(0x81); OLED_WriteCmd(0xCF);
    OLED_WriteCmd(0xD9); OLED_WriteCmd(0xF1);
    OLED_WriteCmd(0xDB); OLED_WriteCmd(0x40);
    OLED_WriteCmd(0xA4);
    OLED_WriteCmd(0xA6);
    OLED_WriteCmd(0xAF);
}

void OLED_Clear(void) {
    for (uint8_t page = 0; page < 8; page++) {
        OLED_WriteCmd(0xB0 + page);
        OLED_WriteCmd(0x00);
        OLED_WriteCmd(0x10);
        for (uint8_t col = 0; col < 128; col++) {
            OLED_WriteData(0x00);
        }
    }
}

void OLED_DrawChar(uint8_t x, uint8_t y, char ch) {
    OLED_WriteCmd(0xB0 + y);
    OLED_WriteCmd(((x & 0xF0) >> 4) | 0x10);
    OLED_WriteCmd((x & 0x0F) | 0x01);
    for (uint8_t i = 0; i < 6; i++) {
        OLED_WriteData(Font6x8[ch - 32][i]);
    }
}

void OLED_DrawString(uint8_t x, uint8_t y, char *str) {
    while (*str) {
        OLED_DrawChar(x, y, *str++);
        x += 6;
    }
}

// ================= Timer2 =================
volatile uint8_t flag_timer = 0;

void Timer2_Init(void) {
    TIM_TimeBaseInitTypeDef tim;
    NVIC_InitTypeDef nvic;

    RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);

    tim.TIM_Prescaler = 7200 - 1;   // 72MHz/7200 = 10kHz
    tim.TIM_Period = 10000 - 1;     // 10kHz/10000 = 1Hz
    tim.TIM_CounterMode = TIM_CounterMode_Up;
    tim.TIM_ClockDivision = TIM_CKD_DIV1;
    TIM_TimeBaseInit(TIM2, &tim);

    TIM_ITConfig(TIM2, TIM_IT_Update, ENABLE);

    nvic.NVIC_IRQChannel = TIM2_IRQn;
    nvic.NVIC_IRQChannelPreemptionPriority = 0;
    nvic.NVIC_IRQChannelSubPriority = 1;
    nvic.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&nvic);

    TIM_Cmd(TIM2, ENABLE);
}

void TIM2_IRQHandler(void) {
    if (TIM_GetITStatus(TIM2, TIM_IT_Update) != RESET) {
        TIM_ClearITPendingBit(TIM2, TIM_IT_Update);
        flag_timer = 1;
    }
}

// ================= MAIN =================
int main(void) {
    char buf[32];
    uint8_t tx = 0x55, rx;

    UART1_Init();
    SPI1_Init();
    OLED_Init();
    OLED_Clear();
    Timer2_Init();

    UART1_SendString("STM32 SPI + UART + OLED demo\r\n");
    OLED_DrawString(0, 0, "JUST FOR FUN");

    while (1) {
        if (flag_timer) {
            flag_timer = 0;

            OLED_CS_LOW();
            rx = SPI1_Transfer(tx);
            OLED_CS_HIGH();

            sprintf(buf, "TX=0x%02X, RX=0x%02X\r\n", tx, rx);
            UART1_SendString(buf);

            tx++;
        }
    }
}